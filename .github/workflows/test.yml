name: test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: checkout repository
        uses: actions/checkout@main

      - name: Configure test (simple)
        id: simple
        shell: pwsh
        run: |
          $expected = (Join-Path $pwd test stubs expected template.tpl)
          $subject = (Join-Path $pwd test subject.tpl)
          $prestine = (Join-Path $pwd test stubs prestine template.tpl)

          Copy-Item -Path $prestine -Destination $subject

          Write-Output "expected-path=$expected" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8NoBOM -Append
          Write-Output "subject-path=$subject" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8NoBOM -Append

      - name: Show content before (simple)
        run: cat "${{ steps.simple.outputs.subject-path }}"

      - name: Show expected content (simple)
        run: cat "${{ steps.simple.outputs.expected-path }}"

      - name: Replace tokens (simple)
        uses: ./
        with:
          path: ${{ steps.simple.outputs.subject-path }}
          throw: true
        env:
          NAME: 'jon'

      - name: Show content after (simple)
        run: cat "${{ steps.simple.outputs.subject-path }}"

      - name: Assert (simple)
        id: assert
        shell: pwsh
        run: |
          $expected = "${{ steps.simple.outputs.expected-path }}"
          $subject = "${{ steps.simple.outputs.subject-path }}"

          $contentExpected = Get-Content -Path $expected -Raw
          $contentActual = Get-Content -Path $subject -Raw

          if (-not $contentExpected -eq $contentActual) {
            Write-Host '✘ Test failed' -ForegroundColor Red
            exit 1
          } else {
            Write-Host '✓ Test passed' -ForegroundColor Green
            exit 0
          }
